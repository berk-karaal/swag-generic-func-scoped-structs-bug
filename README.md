# Update

This issue is fixed by https://github.com/swaggo/swag/pull/1883 . I'm archiving the repo

---

# Swag Generic Struct with Function Scoped Structs Bug

This project demonstrates the bug when generic typed structs used with function scoped structs on
the HEAD version of the [swaggo/swag](https://github.com/swaggo/swag) project.

## Reproduce

My Go version: 1.22.6

1. Clone this project and `cd` into the project directory.

   ```console
   $ git clone https://github.com/berk-karaal/swag-generic-func-scoped-structs-bug.git
   $ cd swag-generic-func-scoped-structs-bug
   ```

2. Install the swag project HEAD version:

    ```console
    $ go install github.com/swaggo/swag/cmd/swag@HEAD

    $ # or more specific, by the commit hash:
    $ go install github.com/swaggo/swag/cmd/swag@10030b02b48c59c73e6c4fd07e3256b61aff339f
    ```

3. Generate swagger documentation using swag:

    ```console
    $ swag init
    ```

    Generated swagger documentation has incorrect response schema references.

## Notes

I included the generated incorrect swagger.json file below. I guess the problem is caused by when
the generics used with function scoped structs, generic schema names are not being generated
correctly and overwrites each other.

<details>
  <summary>swagger.json generated by the HEAD version</summary>

  ```jsonc
    {
        "swagger": "2.0",
        "info": {
            "description": "This is a sample server.",
            "title": "Swagger Example API",
            "contact": {},
            "version": "1.0"
        },
        "host": "localhost:8080",
        "basePath": "/api",
        "paths": {
            "/": {
                "get": {
                    "produces": [
                        "application/json"
                    ],
                    "summary": "Generic Response",
                    "responses": {
                        "200": {
                            "description": "OK",
                            "schema": {
                                "$ref": "#/definitions/types.GenericResponse-"  // wrong
                            }
                        },
                        "201": {
                            "description": "Created",
                            "schema": {
                                "$ref": "#/definitions/types.GenericResponse-"  // wrong
                            }
                        }
                    }
                }
            },
            "/multi": {
                "get": {
                    "produces": [
                        "application/json"
                    ],
                    "summary": "Multiple Generic Response",
                    "responses": {
                        "200": {
                            "description": "OK",
                            "schema": {
                                "$ref": "#/definitions/types.GenericMultiResponse--"  // wrong
                            }
                        },
                        "201": {
                            "description": "Created",
                            "schema": {
                                "$ref": "#/definitions/types.GenericMultiResponse--"  // wrong
                            }
                        }
                    }
                }
            }
        },
        "definitions": {
            "api.GetGeneric.Post": {
                "type": "object",
                "properties": {
                    "slug": {
                        "type": "integer"
                    },
                    "title": {
                        "type": "string"
                    }
                }
            },
            "api.GetGeneric.User": {
                "type": "object",
                "properties": {
                    "email": {
                        "type": "string"
                    },
                    "username": {
                        "type": "integer"
                    }
                }
            },
            "api.GetGenericMulti.Bar": {
                "type": "object",
                "properties": {
                    "some_field_b": {
                        "type": "string"
                    }
                }
            },
            "api.GetGenericMulti.Foo": {
                "type": "object",
                "properties": {
                    "some_field_a": {
                        "type": "string"
                    }
                }
            },
            "types.GenericMultiResponse--": {  // wrong
                "type": "object",
                "properties": {
                    "data_t": {
                        "$ref": "#/definitions/api.GetGenericMulti.Bar"
                    },
                    "data_x": {
                        "$ref": "#/definitions/api.GetGenericMulti.Foo"
                    },
                    "status": {
                        "type": "string"
                    }
                }
            },
            "types.GenericResponse-": {  // wrong
                "type": "object",
                "properties": {
                    "data": {
                        "$ref": "#/definitions/api.GetGeneric.Post"
                    },
                    "status": {
                        "type": "string"
                    }
                }
            }
        }
    }
  ```
</details>

<br>

There is no issue before the
[[issue 1863] fix parse nested structs and aliases #1866](https://github.com/swaggo/swag/pull/1866)
PR merge. Before this merge, `swag init` generates this which is correct:

<details>
  <summary>swagger.json generated correctly before the #1866 PR</summary>

  ```console
  $ # install swag from the latest commit before the #1866 PR
  $ go install github.com/swaggo/swag/cmd/swag@c7f1cd8e8e3702096516b82068b662a29eb79dea
  $ swag init
  ```

  ```jsonc
    {
        "swagger": "2.0",
        "info": {
            "description": "This is a sample server.",
            "title": "Swagger Example API",
            "contact": {},
            "version": "1.0"
        },
        "host": "localhost:8080",
        "basePath": "/api",
        "paths": {
            "/": {
                "get": {
                    "produces": [
                        "application/json"
                    ],
                    "summary": "Generic Response",
                    "responses": {
                        "200": {
                            "description": "OK",
                            "schema": {
                                "$ref": "#/definitions/types.GenericResponse-api_GetGeneric_User"  // OK
                            }
                        },
                        "201": {
                            "description": "Created",
                            "schema": {
                                "$ref": "#/definitions/types.GenericResponse-api_GetGeneric_Post"  // OK
                            }
                        }
                    }
                }
            },
            "/multi": {
                "get": {
                    "produces": [
                        "application/json"
                    ],
                    "summary": "Multiple Generic Response",
                    "responses": {
                        "200": {
                            "description": "OK",
                            "schema": {
                                "$ref": "#/definitions/types.GenericMultiResponse-api_GetGenericMulti_Foo-api_GetGenericMulti_Bar"  // OK
                            }
                        },
                        "201": {
                            "description": "Created",
                            "schema": {
                                "$ref": "#/definitions/types.GenericMultiResponse-api_GetGenericMulti_Bar-api_GetGenericMulti_Foo"  // OK
                            }
                        }
                    }
                }
            }
        },
        "definitions": {
            "api.GetGeneric.Post": {
                "type": "object",
                "properties": {
                    "slug": {
                        "type": "integer"
                    },
                    "title": {
                        "type": "string"
                    }
                }
            },
            "api.GetGeneric.User": {
                "type": "object",
                "properties": {
                    "email": {
                        "type": "string"
                    },
                    "username": {
                        "type": "integer"
                    }
                }
            },
            "api.GetGenericMulti.Bar": {
                "type": "object",
                "properties": {
                    "some_field_b": {
                        "type": "string"
                    }
                }
            },
            "api.GetGenericMulti.Foo": {
                "type": "object",
                "properties": {
                    "some_field_a": {
                        "type": "string"
                    }
                }
            },
            "types.GenericMultiResponse-api_GetGenericMulti_Bar-api_GetGenericMulti_Foo": {  // OK
                "type": "object",
                "properties": {
                    "data_t": {
                        "$ref": "#/definitions/api.GetGenericMulti.Bar"
                    },
                    "data_x": {
                        "$ref": "#/definitions/api.GetGenericMulti.Foo"
                    },
                    "status": {
                        "type": "string"
                    }
                }
            },
            "types.GenericMultiResponse-api_GetGenericMulti_Foo-api_GetGenericMulti_Bar": {  // OK
                "type": "object",
                "properties": {
                    "data_t": {
                        "$ref": "#/definitions/api.GetGenericMulti.Foo"
                    },
                    "data_x": {
                        "$ref": "#/definitions/api.GetGenericMulti.Bar"
                    },
                    "status": {
                        "type": "string"
                    }
                }
            },
            "types.GenericResponse-api_GetGeneric_Post": {  // OK
                "type": "object",
                "properties": {
                    "data": {
                        "$ref": "#/definitions/api.GetGeneric.Post"
                    },
                    "status": {
                        "type": "string"
                    }
                }
            },
            "types.GenericResponse-api_GetGeneric_User": {  // OK
                "type": "object",
                "properties": {
                    "data": {
                        "$ref": "#/definitions/api.GetGeneric.User"
                    },
                    "status": {
                        "type": "string"
                    }
                }
            }
        }
    }
  ```
</details>
